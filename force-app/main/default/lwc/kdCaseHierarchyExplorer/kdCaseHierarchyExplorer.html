<template>
    <!-- ───────────── CONFIGURE COLUMNS MODE ───────────── -->
    <template if:true={isConfigMode}>
        <lightning-card title="Configure Columns">
            <div class="slds-p-horizontal_small" style="overflow: visible; position: relative; z-index: 100;">
                <div style="overflow: visible; position: relative; min-height: 300px;">
                    <c-datatable-picklist
                        key-field="_id"
                        data={draftColumns}
                        columns={configColumns}
                        draft-values={draftValues}
                        hide-checkbox-column
                        suppress-bottom-bar
                        oncellchange={handleCellChange}
                        onrowaction={handleRowAction}
                        style="overflow: visible; position: relative;">
                    </c-datatable-picklist>
                </div>

                <div class="slds-m-top_large slds-align_absolute-center">
                    <lightning-button label="Add column" variant="neutral"
                                      onclick={handleAdd}></lightning-button>
                    <lightning-button label="Cancel" variant="destructive-text"
                                      class="slds-m-left_x-small"
                                      onclick={handleCancel}></lightning-button>
                    <lightning-button label="Save" variant="brand"
                                      class="slds-m-left_x-small"
                                      onclick={handleSave}></lightning-button>
                </div>
            </div>
        </lightning-card>
    </template>

    <!-- ───────────── NORMAL VIEW MODE ───────────── -->
    <template if:false={isConfigMode}>
        <lightning-card title="Case Hierarchy">
            <div class="slds-p-horizontal_small">
                <lightning-button label="Configure Columns"
                                  onclick={handleToggleConfig}></lightning-button>

                <!-- simple error message (replaces c:error-panel) -->
                <template if:true={hasError}>
                    <p class="slds-text-color_error slds-m-top_small">{errorMessage}</p>
                </template>

                <template if:true={noCasesFound}>
                    <p class="slds-m-top_medium">No cases found for this record.</p>
                </template>

                <template if:false={noCasesFound}>
                    <lightning-tree-grid
                        key-field="id"
                        columns={columns}
                        data={treeData}
                        expanded-rows={expandedRows}
                        onrowtoggle={handleRowToggle}
                        is-loading={isLoading}>
                    </lightning-tree-grid>
                </template>
            </div>
        </lightning-card>
    </template>
</template>